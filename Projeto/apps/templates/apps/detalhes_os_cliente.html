{% extends 'global/base.html' %}
{% load static %}

{% block content %}

<title>Detalhes da Ordem de Serviço</title>

<link rel="stylesheet" type="text/css" href="{% static 'css/details_page.css' %}">

<section class="details-page">
    <div class="details-page__card">
        {% if os.imagem %}
        <img src="{{ os.imagem.url }}" class="details-page__card-img" alt="{{ os.descricao }}">
        {% else %}
        <svg class="details-page__card-placeholder" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="Placeholder: Thumbnail" preserveAspectRatio="xMidYMid slice" focusable="false">
            <title>Placeholder</title>
            <rect width="100%" height="100%" fill="#55595c"></rect>
            <text x="50%" y="50%" fill="#eceeef" dy=".3em">{{ os.descricao }}</text>
        </svg>
        {% endif %}
    </div>
    <div class="details-page__info">
        <h2 class="details-page__info-title">Detalhes da Ordem de Serviço</h2>
        <ul class="details-page__info-list">
            <li><strong>Número da OS:</strong> {{ os.numero|default:"-" }}</li>
            <li><strong>Data de Entrada:</strong> {{ os.created_at|date:"d/m/Y" }}</li>
            <li><strong>Cliente:</strong> {{ os.perfil_os.username }}</li>
            <li><strong>Tipo de Atendimento:</strong> {{ os.tipo_atendimento }}</li>
            <li><strong>Status:</strong> {{ os.status }}</li>
            {% if os.status == 'Pronto' %}
            <div class="details-page__info-actions">
                {% if os.avaliacao %}
                <a href="{% url 'avaliar_os' os.id %}" class="btn btn-outline-secondary">Editar Avaliação</a>
                <p>Sua avaliação:<span class="rating" data-rating="{{ os.avaliacao }}"></span></p>
                {% else %}
                <a href="{% url 'avaliar_os' os.id %}" class="btn btn-outline-secondary">Avaliar Ordem de Serviço</a>
                {% endif %}
            </div>
            {% endif %}
        </ul>
    </div>
    {% if os.status == 'Enviada' %}
    <div class="details-page__status">
        <h3 class="details-page__status-title">Aguardando Responsabilidade</h3>
    </div>
    {% else %}
    <div class="details-page__status">
        <section class="step-wizard">
            <ul class="step-wizard-list">
                <li class="step-wizard-item {% if os.status == 'Iniciada' %}current-item{% endif %}">
                    <span class="progress-count">1</span>
                    <span class="progress-label">Iniciada</span>
                </li>
                <li class="step-wizard-item {% if os.status == 'Em_analise' %}current-item{% endif %}">
                    <span class="progress-count">2</span>
                    <span class="progress-label">Em análise</span>
                </li>
                <li class="step-wizard-item {% if os.status == 'Aguardando_peca' %}current-item{% endif %}">
                    <span class="progress-count">3</span>
                    <span class="progress-label">Aguardando peça</span>
                </li>
                <li class="step-wizard-item {% if os.status == 'Aguardando_reparo' %}current-item{% endif %}">
                    <span class="progress-count">4</span>
                    <span class="progress-label">Aguardando reparo</span>
                </li>
                <li class="step-wizard-item {% if os.status == 'Em_reparo' %}current-item{% endif %}">
                    <span class="progress-count">5</span>
                    <span class="progress-label">Em reparo</span>
                </li>
                <li class="step-wizard-item {% if os.status == 'Pronto' %}current-item{% endif %}">
                    <span class="progress-count">6</span>
                    <span class="progress-label">Pronto</span>
                </li>
            </ul>
        </section>
        <div class="details-page__comments">
            <label for="comentarios_funcionario">Comentários do Funcionário:</label>
            <textarea id="comentarios_funcionario" class="form-control" rows="5" readonly>{{ os.mensagem_funcionario|default:"Ainda sem comentários" }}</textarea>
        </div>
    </div>
    {% endif %}
</section>

<script type="text/javascript" src="{% static 'js/details_page.js' %}">
    function renderStars(rating) {
        let stars = '';
        for (let i = 0; i < 5; i++) {
            if (i < rating) {
                stars += '★'; // Filled star
            } else {
                stars += '☆'; // Empty star
            }
        }
        return stars;
    }

    window.onload = function() {
        var ratingElements = document.getElementsByClassName('rating');
        for (var i = 0; i < ratingElements.length; i++) {
            var ratingElement = ratingElements[i];
            var rating = ratingElement.getAttribute('data-rating');
            ratingElement.innerHTML = renderStars(rating);
        }
    }
</script>

{% endblock %}
